<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベント一覧</title>

    <!-- ★ 地図★ Leaflet CSS ★ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />

    <!-- ★ 外部CSSファイル ★ -->
    <link rel=stylesheet href="{{ url_for('static', filename='style_index.css') }}"> <!-- staticフォルダ内にCSSファイルを配置してください -->

</head>

<body>
    <div class="page">
        <h1>どこいこ(仮)</h1>
        <div class="metanav">
            {% if not current_user.is_authenticated %}
            <a href="{{ url_for('user_bp.login') }}">LogIn</a>
            <a href="{{ url_for('user_bp.register') }}">Register</a>
            {% else %}
            <a href="{{ url_for('user_bp.logout') }}">LogOut</a>
            {% endif %}
        </div>

        {% for message in get_flashed_messages() %}
        <p>{{ message }}</p>
        {% endfor %}

        {% if current_user.is_authenticated %}
        <p>{{ current_user.name }} さんこんにちは</p>
        {% else %}
        <p>ログインしていません</p>
        {% endif %}

        <h2>日付で検索</h2>
        <form action="/" method="GET">
            <label for="start_date">開始日:</label>
            <input type="date" id="start_date" name="start_date">

            <label for="end_date">終了日:</label>
            <input type="date" id="end_date" name="end_date">

            <input type="submit" value="検索">
        </form>


        <h3>イベント一覧</h3>
        <a href="{{ url_for('create_events') }}" class="create-event">イベントを新規登録する</a>
        <ul>
            {% for event in events %}
            <li>
                <a href="{{ url_for('event_detail', event_id=event.id) }}" class="event-name">{{ event.name }}</a>
                <p>日時 : {{ event.get_start_date() }} - {{ event.get_end_date() }}</p>
                <p>場所 : {{ event.place }}</p>
                <p>住所 : {{ event.address }}</p>
                {% if event.url %}
                <a href="{{ event.url }}" target="_blank">WEBページ</a>
                {% endif %}
            </li>
            {% else %}
            <li>該当するイベントはありません。</li>
            {% endfor %}
        </ul>

        <!-- ★★★ 地図の表示部分 ★★★ -->
        <h4>イベントの場所</h4>
        <div id="map"></div>
    </div>

    <!-- ★ Leaflet JS ★ -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script>
        function init() {
            // 地図を表示するdiv要素のidを設定
            var map = L.map('map');  // 'map'というIDを使う

            // 地図の中心を設定
            var mpoint = [39.701437, 141.136723];
            map.setView(mpoint, 15);

            // タイルレイヤを追加
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // スケールコントロールを追加
            L.control.scale({
                maxWidth: 200,
                position: 'bottomright',
                imperial: false
            }).addTo(map);

            // ズームコントロールを追加
            L.control.zoom({
                position: 'bottomleft'
            }).addTo(map);

            // イベントごとのマーカーを追加
            {% for event in events %}
                {% if event.lat and event.lng %}
                L.marker([{{ event.lat }}, {{ event.lng }}])
                    .bindPopup("{{ event.name }}")
                    .addTo(map);
                {% endif %}
            {% endfor %}
        }

        // ページがロードされたら地図を初期化
        window.onload = init;
    </script>
</body>

</html>
